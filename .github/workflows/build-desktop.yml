name: Build Desktop Apps

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release (e.g. v1.0.0)'
        required: false
        default: ''

env:
  PYTHON_VERSION: "3.12"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  version:
    uses: ./.github/workflows/get-version.yml
    with:
      tag_name: ${{ github.event.inputs.tag_name }}

  # ===========================================================================
  # Build for all desktop platforms
  # ===========================================================================
  build:
    name: Build for ${{ matrix.os }}
    needs: version
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: StreamCatch-Linux
            binary_path: dist/StreamCatch
          - os: windows-latest
            artifact_name: StreamCatch-Windows
            binary_path: dist/StreamCatch.exe
          - os: macos-latest
            artifact_name: StreamCatch-macOS
            binary_path: dist/StreamCatch.app
      fail-fast: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Install platform dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev fakeroot patchelf

    - name: Build with Nuitka
      env:
        APP_VERSION: ${{ needs.version.outputs.version }}
      run: |
        python scripts/build_installer.py

    - name: Verify build output
      shell: bash
      run: |
        if [ -d "dist" ]; then
          echo "Build output:"
          ls -la dist/
        else
          echo "ERROR: dist directory not found!"
          exit 1
        fi

    # =========================================================================
    # Windows: Create Installer
    # =========================================================================
    - name: Install Inno Setup (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install innosetup -y

    - name: Build Windows installer
      if: matrix.os == 'windows-latest'
      shell: powershell
      run: |
        $env:APP_VERSION = "${{ needs.version.outputs.version }}"
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installers/setup.iss

    - name: Upload Windows Installer
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: StreamCatch-Windows-Installer
        path: installers/output/StreamCatch_Setup_v*.exe
        if-no-files-found: error
        retention-days: 30

    # =========================================================================
    # Linux: Create .deb package
    # =========================================================================
    - name: Build Linux .deb
      if: matrix.os == 'ubuntu-latest'
      env:
        APP_VERSION: ${{ needs.version.outputs.version }}
      run: |
        # Strip 'v' prefix from version for deb package
        DEB_VERSION="${APP_VERSION#v}"
        # Ensure version starts with a digit (Debian requirement)
        if ! [[ "$DEB_VERSION" =~ ^[0-9] ]]; then
          DEB_VERSION="0.0.0-${DEB_VERSION}"
        fi
        
        echo "Building .deb with version: $DEB_VERSION"
        
        # Create directory structure
        mkdir -p deb_dist/streamcatch/usr/local/bin
        mkdir -p deb_dist/streamcatch/usr/share/applications
        mkdir -p deb_dist/streamcatch/usr/share/icons/hicolor/256x256/apps
        mkdir -p deb_dist/streamcatch/DEBIAN
        
        # Copy binary
        cp dist/streamcatch deb_dist/streamcatch/usr/local/bin/streamcatch
        chmod +x deb_dist/streamcatch/usr/local/bin/streamcatch
        
        # Create desktop entry
        cat > deb_dist/streamcatch/usr/share/applications/streamcatch.desktop << 'EOF'
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=StreamCatch
        Comment=Ultimate Video Downloader
        Exec=/usr/local/bin/streamcatch
        Icon=streamcatch
        Terminal=false
        Categories=Network;FileTransfer;AudioVideo;
        Keywords=youtube;video;download;
        EOF
        
        # Copy icon if exists
        if [ -f assets/logo.png ]; then
          cp assets/logo.png deb_dist/streamcatch/usr/share/icons/hicolor/256x256/apps/streamcatch.png
        elif [ -f assets/icon.png ]; then
          cp assets/icon.png deb_dist/streamcatch/usr/share/icons/hicolor/256x256/apps/streamcatch.png
        fi
        
        # Create control file
        cat > deb_dist/streamcatch/DEBIAN/control << EOF
        Package: streamcatch
        Version: ${DEB_VERSION}
        Section: net
        Priority: optional
        Architecture: amd64
        Depends: libgtk-3-0, ffmpeg
        Maintainer: StreamCatch Team <support@streamcatch.app>
        Description: Ultimate Video Downloader
         StreamCatch is a powerful GUI video downloader supporting
         YouTube, Telegram, Twitter/X, Instagram, and thousands more.
         Built with Flet (Flutter for Python) and yt-dlp.
        EOF
        
        # Build .deb
        fakeroot dpkg-deb --build deb_dist/streamcatch
        mv deb_dist/streamcatch.deb "streamcatch_${DEB_VERSION}_amd64.deb"
        
        echo "Created: streamcatch_${DEB_VERSION}_amd64.deb"

    - name: Upload Linux .deb
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: StreamCatch-Linux-Deb
        path: streamcatch_*_amd64.deb
        if-no-files-found: error
        retention-days: 30

    # =========================================================================
    # macOS: Create .dmg
    # =========================================================================
    - name: Build macOS .dmg
      if: matrix.os == 'macos-latest'
      env:
        APP_VERSION: ${{ needs.version.outputs.version }}
      run: |
        APP_PATH="dist/StreamCatch.app"
        
        if [ ! -d "$APP_PATH" ]; then
          echo "ERROR: $APP_PATH not found"
          ls -la dist/ || true
          exit 1
        fi
        
        # Create DMG
        hdiutil create \
          -volname "StreamCatch" \
          -srcfolder "$APP_PATH" \
          -ov \
          -format UDZO \
          "StreamCatch-${APP_VERSION}-macOS.dmg"
        
        echo "Created: StreamCatch-${APP_VERSION}-macOS.dmg"

    - name: Upload macOS .dmg
      if: matrix.os == 'macos-latest'
      uses: actions/upload-artifact@v4
      with:
        name: StreamCatch-macOS-Dmg
        path: StreamCatch-*-macOS.dmg
        if-no-files-found: error
        retention-days: 30

  # ===========================================================================
  # Create GitHub Release
  # ===========================================================================
  release:
    name: Create Release
    needs: [version, build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:

    - name: Download Windows Artifact
      uses: actions/download-artifact@v4
      with:
        name: StreamCatch-Windows-Installer
        path: ./windows

    - name: Download Linux Artifact
      uses: actions/download-artifact@v4
      with:
        name: StreamCatch-Linux-Deb
        path: ./linux

    - name: Download macOS Artifact
      uses: actions/download-artifact@v4
      with:
        name: StreamCatch-macOS-Dmg
        path: ./macos

    - name: Prepare release files
      run: |
        mkdir -p release
        
        # Windows
        mv windows/StreamCatch_Setup_v*.exe release/StreamCatch-Windows-Installer.exe 2>/dev/null || \
        mv windows/*.exe release/StreamCatch-Windows-Installer.exe
        
        # Linux
        mv linux/streamcatch_*_amd64.deb release/StreamCatch-Linux-amd64.deb 2>/dev/null || \
        mv linux/*.deb release/StreamCatch-Linux-amd64.deb
        
        # macOS
        mv macos/StreamCatch-*-macOS.dmg release/StreamCatch-macOS.dmg 2>/dev/null || \
        mv macos/*.dmg release/StreamCatch-macOS.dmg
        
        echo "=== Release files ==="
        ls -la release/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.tag_name || github.ref_name }}
        draft: ${{ github.event_name == 'workflow_dispatch' }}
        generate_release_notes: true
        files: |
          release/StreamCatch-Windows-Installer.exe
          release/StreamCatch-Linux-amd64.deb
          release/StreamCatch-macOS.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
