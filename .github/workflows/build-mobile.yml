name: Build Mobile Apps

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip openjdk-17-jdk python3-pip \
          autoconf libtool pkg-config zlib1g-dev \
          libncurses5-dev libncursesw5-dev libtinfo5 \
          cmake libffi-dev libssl-dev

    - name: Cache Buildozer global directory
      uses: actions/cache@v3
      with:
        path: ~/.buildozer
        key: buildozer-global-${{ hashFiles('mobile/buildozer.spec') }}

    - name: Cache Buildozer directory
      uses: actions/cache@v3
      with:
        path: mobile/.buildozer
        key: buildozer-${{ hashFiles('mobile/buildozer.spec') }}

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython==0.29.33

    - name: Build APK with Buildozer
      working-directory: ./mobile
      run: |
        buildozer android debug

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: StreamCatch-Android-APK
        path: mobile/bin/*.apk
        if-no-files-found: error

  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest
    continue-on-error: true  # iOS builds require code signing setup

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install kivy[base] kivymd
        brew install autoconf automake libtool pkg-config

    - name: Install Kivy iOS toolchain
      run: |
        pip install kivy-ios

    - name: Cache iOS toolchain builds
      uses: actions/cache@v3
      with:
        path: ~/.kivy-ios
        key: kivy-ios-toolchain-${{ runner.os }}

    - name: Build iOS dependencies
      run: |
        toolchain build python3 kivy kivymd

    - name: Create Xcode project
      working-directory: ./mobile
      run: |
        toolchain create StreamCatch .

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Build IPA (requires code signing)
      working-directory: ./mobile/StreamCatch-ios
      continue-on-error: true
      run: |
        # Note: This step requires proper code signing certificates
        # Configure in repository secrets: APPLE_CERTIFICATE, APPLE_CERT_PASSWORD, PROVISIONING_PROFILE
        xcodebuild -project StreamCatch.xcodeproj \
          -scheme StreamCatch \
          -configuration Release \
          -archivePath StreamCatch.xcarchive \
          archive || echo "Code signing not configured - skipping IPA build"

    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: StreamCatch-iOS-IPA
        path: mobile/StreamCatch-ios/*.ipa
        if-no-files-found: warn

  release:
    needs: [build-android, build-ios]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: StreamCatch-Android-APK
          path: ./android

      - name: Download iOS IPA
        uses: actions/download-artifact@v4
        with:
          name: StreamCatch-iOS-IPA
          path: ./ios
        continue-on-error: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            android/*.apk
            ios/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
