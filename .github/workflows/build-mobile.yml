name: Build Mobile Apps

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip openjdk-17-jdk python3-pip \
          autoconf automake libtool pkg-config zlib1g-dev \
          libncurses5-dev libncursesw5-dev \
          cmake libffi-dev libssl-dev
        sudo apt-get install -y libtinfo6 || sudo apt-get install -y libtinfo5 || true

    - name: Cache Buildozer global directory
      uses: actions/cache@v3
      with:
        path: ~/.buildozer
        key: buildozer-global-${{ hashFiles('mobile/buildozer.spec') }}

    - name: Cache Buildozer directory
      uses: actions/cache@v3
      with:
        path: mobile/.buildozer
        key: buildozer-${{ hashFiles('mobile/buildozer.spec') }}

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer>=1.5.0 cython==0.29.33

    - name: Prepare Android SDK Directories
      run: |
        mkdir -p ~/.buildozer/android/platform/android-sdk/cmdline-tools
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg

    - name: Download and Install Android Command Line Tools
      run: |
        cd ~/.buildozer/android/platform/android-sdk/cmdline-tools
        wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip commandlinetools-linux-11076708_latest.zip
        mv cmdline-tools latest
        rm commandlinetools-linux-11076708_latest.zip

        # Accept licenses
        yes | ~/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true

        # Install required SDK components
        ~/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0"

    - name: Build APK with Buildozer
      working-directory: ./mobile
      run: |
        buildozer android debug

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: StreamCatch-Android-APK
        path: mobile/bin/*.apk
        if-no-files-found: error

  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Cache pip packages (iOS)
      uses: actions/cache@v3
      with:
        path: ~/Library/Caches/pip
        key: ios-pip-${{ runner.os }}-${{ hashFiles('mobile/buildozer.spec') }}
        restore-keys: |
          ios-pip-${{ runner.os }}-

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install cython==0.29.36 kivy[base] kivymd
        brew install autoconf automake libtool pkg-config libffi

    - name: Install Kivy iOS toolchain
      run: |
        pip install kivy-ios

    - name: Cache iOS toolchain builds
      uses: actions/cache@v3
      with:
        path: ~/.kivy-ios
        key: kivy-ios-toolchain-${{ runner.os }}-v2
        restore-keys: |
          kivy-ios-toolchain-${{ runner.os }}-v2

    - name: Build iOS dependencies
      run: |
        # Build python3 first as it's required for all other recipes
        toolchain build python3
        # Build kivy after python3
        toolchain build kivy

    - name: Create Xcode project
      working-directory: ./mobile
      run: |
        # Ensure the toolchain has built python3
        if [ ! -d "$HOME/.kivy-ios/dist/lib/python3.11" ] && [ ! -d "$HOME/.kivy-ios/dist/lib/python3.10" ]; then
          echo "Error: Python3 not found in kivy-ios distribution"
          exit 1
        fi
        toolchain create StreamCatch .

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Copy exportOptions.plist to Xcode project
      run: |
        cp mobile/exportOptions.plist mobile/StreamCatch-ios/exportOptions.plist

    - name: Archive iOS app
      working-directory: ./mobile/StreamCatch-ios
      continue-on-error: true
      run: |
        # Note: This step requires proper code signing certificates
        # Configure in repository secrets: APPLE_CERTIFICATE, APPLE_CERT_PASSWORD, PROVISIONING_PROFILE
        xcodebuild -project StreamCatch.xcodeproj \
          -scheme StreamCatch \
          -configuration Release \
          -archivePath StreamCatch.xcarchive \
          archive

    - name: Export IPA from archive
      working-directory: ./mobile/StreamCatch-ios
      continue-on-error: true
      run: |
        xcodebuild -exportArchive \
          -archivePath StreamCatch.xcarchive \
          -exportPath ./ipa-output \
          -exportOptionsPlist exportOptions.plist

    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: StreamCatch-iOS-IPA
        path: mobile/StreamCatch-ios/ipa-output/*.ipa
        if-no-files-found: warn

  release:
    needs: [build-android, build-ios]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: StreamCatch-Android-APK
          path: ./android

      - name: Download iOS IPA
        uses: actions/download-artifact@v4
        with:
          name: StreamCatch-iOS-IPA
          path: ./ios
        continue-on-error: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            android/*.apk
            ios/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
