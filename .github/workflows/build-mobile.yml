name: Build Mobile Apps

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip openjdk-17-jdk python3-pip \
          autoconf libtool pkg-config zlib1g-dev \
          libncurses5-dev libncursesw5-dev \
          cmake libffi-dev libssl-dev
        sudo apt-get install -y libtinfo6 || sudo apt-get install -y libtinfo5 || true

    - name: Cache Buildozer global directory
      uses: actions/cache@v3
      with:
        path: ~/.buildozer
        key: buildozer-global-${{ hashFiles('mobile/buildozer.spec') }}

    - name: Cache Buildozer directory
      uses: actions/cache@v3
      with:
        path: mobile/.buildozer
        key: buildozer-${{ hashFiles('mobile/buildozer.spec') }}

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython==0.29.33

    - name: Install Android SDK Command-line Tools
      run: |
        ANDROID_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
        mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
        cd "$ANDROID_SDK_ROOT"
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
        unzip -q cmdline-tools.zip -d cmdline-tools
        rm cmdline-tools.zip
        mv cmdline-tools/cmdline-tools "$ANDROID_SDK_ROOT/cmdline-tools/latest"

        # Create a symlink 'tools' pointing to 'cmdline-tools/latest' to satisfy legacy path lookups
        ln -s "$ANDROID_SDK_ROOT/cmdline-tools/latest" "$ANDROID_SDK_ROOT/tools"

        yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses
        "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --install "platform-tools"

    - name: Accept Android SDK Licenses
      run: |
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        mkdir -p ~/.android/licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > ~/.android/licenses/android-sdk-license
        echo "d975f751176514f0d05d68b988f5025c1af67300" > ~/.android/licenses/android-sdk-preview-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > ~/.android/licenses/google-nexus-15-preview-license

    - name: Pre-accept SDK Manager Licenses
      run: |
        mkdir -p ~/.buildozer/android/platform/android-sdk/licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
        echo "d975f751176514f0d05d68b988f5025c1af67300" > ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-preview-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > ~/.buildozer/android/platform/android-sdk/licenses/google-nexus-15-preview-license

    - name: Build APK with Buildozer
      working-directory: ./mobile
      run: |
        export ANDROID_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
        export ANDROID_HOME="$ANDROID_SDK_ROOT"
        export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"
        buildozer android debug
      env:
        ANDROID_SDK_ROOT: ~/.buildozer/android/platform/android-sdk
        ANDROID_HOME: ~/.buildozer/android/platform/android-sdk

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: StreamCatch-Android-APK
        path: mobile/bin/*.apk
        if-no-files-found: error

  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Cache pip packages (iOS)
      uses: actions/cache@v3
      with:
        path: ~/Library/Caches/pip
        key: ios-pip-${{ runner.os }}-${{ hashFiles('mobile/buildozer.spec') }}
        restore-keys: |
          ios-pip-${{ runner.os }}-

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install cython kivy[base] kivymd
        brew install autoconf automake libtool pkg-config libffi

    - name: Install Kivy iOS toolchain
      run: |
        pip install kivy-ios

    - name: Cache iOS toolchain builds
      uses: actions/cache@v3
      with:
        path: ~/.kivy-ios
        key: kivy-ios-toolchain-${{ runner.os }}
        restore-keys: |
          kivy-ios-toolchain-${{ runner.os }}

    - name: Build iOS dependencies
      run: |
        toolchain build python3 kivy

    - name: Create Xcode project
      working-directory: ./mobile
      run: |
        toolchain create StreamCatch .

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Copy exportOptions.plist to Xcode project
      run: |
        cp mobile/exportOptions.plist mobile/StreamCatch-ios/exportOptions.plist

    - name: Archive iOS app
      working-directory: ./mobile/StreamCatch-ios
      continue-on-error: true
      run: |
        # Note: This step requires proper code signing certificates
        # Configure in repository secrets: APPLE_CERTIFICATE, APPLE_CERT_PASSWORD, PROVISIONING_PROFILE
        xcodebuild -project StreamCatch.xcodeproj \
          -scheme StreamCatch \
          -configuration Release \
          -archivePath StreamCatch.xcarchive \
          archive

    - name: Export IPA from archive
      working-directory: ./mobile/StreamCatch-ios
      continue-on-error: true
      run: |
        xcodebuild -exportArchive \
          -archivePath StreamCatch.xcarchive \
          -exportPath ./ipa-output \
          -exportOptionsPlist exportOptions.plist

    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: StreamCatch-iOS-IPA
        path: mobile/StreamCatch-ios/ipa-output/*.ipa
        if-no-files-found: warn

  release:
    needs: [build-android, build-ios]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: StreamCatch-Android-APK
          path: ./android

      - name: Download iOS IPA
        uses: actions/download-artifact@v4
        with:
          name: StreamCatch-iOS-IPA
          path: ./ios
        continue-on-error: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            android/*.apk
            ios/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
