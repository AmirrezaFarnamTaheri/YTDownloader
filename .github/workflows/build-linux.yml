name: Build Linux

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Derive build version
      shell: bash
      run: |
        if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
          VERSION="${GITHUB_REF#refs/tags/v}"
        elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
          VERSION="${GITHUB_REF#refs/tags/}"
        else
          VERSION="dev-${{ github.run_number }}"
        fi
        VERSION="${VERSION// /}"
        echo "APP_VERSION=${VERSION}" >> "$GITHUB_ENV"

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev fakeroot
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install nuitka zstandard

    - name: Build binary with Nuitka
      run: |
        python -m nuitka --standalone --onefile \
          --include-data-dir=assets=assets \
          --include-data-dir=locales=locales \
          --output-dir=dist \
          --output-filename=StreamCatch \
          main.py

    - name: Create Deb Package Structure
      env:
        APP_VERSION: ${{ env.APP_VERSION }}
      run: |
        # Strip 'v' prefix and ensure version starts with a digit
        DEB_VERSION="${APP_VERSION#v}"
        if ! [[ "$DEB_VERSION" =~ ^[0-9] ]]; then
          DEB_VERSION="0.0.0-${DEB_VERSION}"
        fi

        mkdir -p deb_dist/streamcatch/usr/local/bin
        mkdir -p deb_dist/streamcatch/usr/share/applications
        mkdir -p deb_dist/streamcatch/usr/share/icons/hicolor/scalable/apps
        cp dist/StreamCatch deb_dist/streamcatch/usr/local/bin/streamcatch

        # Create Desktop Entry
        cat > deb_dist/streamcatch/usr/share/applications/streamcatch.desktop <<EOD
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=StreamCatch
        Comment=Ultimate Video Downloader
        Exec=/usr/local/bin/streamcatch
        Icon=streamcatch
        Terminal=false
        Categories=Network;FileTransfer;
        EOD

        # Copy Icon (Assuming SVG exists)
        if [ -f assets/logo.svg ]; then
          cp assets/logo.svg deb_dist/streamcatch/usr/share/icons/hicolor/scalable/apps/streamcatch.svg
        fi

        # Control File
        mkdir -p deb_dist/streamcatch/DEBIAN
        cat > deb_dist/streamcatch/DEBIAN/control <<EOD
        Package: streamcatch
        Version: ${DEB_VERSION}
        Architecture: amd64
        Maintainer: StreamCatch Team
        Description: Ultimate Video Downloader
         StreamCatch is a powerful GUI video downloader supporting YouTube, Telegram, and more.
        EOD

    - name: Build Deb
      env:
        APP_VERSION: ${{ env.APP_VERSION }}
      run: |
        # Strip 'v' prefix and ensure version starts with a digit
        DEB_VERSION="${APP_VERSION#v}"
        if ! [[ "$DEB_VERSION" =~ ^[0-9] ]]; then
          DEB_VERSION="0.0.0-${DEB_VERSION}"
        fi
        dpkg-deb --build deb_dist/streamcatch
        mv deb_dist/streamcatch.deb streamcatch_${DEB_VERSION}_amd64.deb

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: StreamCatch_Linux_Deb
        path: streamcatch_*_amd64.deb
