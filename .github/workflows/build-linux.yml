name: Build Linux

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Derive build version
      run: |
        if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
          echo "APP_VERSION=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_ENV"
        elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
          echo "APP_VERSION=${GITHUB_REF#refs/tags/}" >> "$GITHUB_ENV"
        else
          echo "APP_VERSION=dev-${{ github.run_number }}" >> "$GITHUB_ENV"
        fi
      shell: bash

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev fakeroot
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build with PyInstaller
      run: |
        pyinstaller streamcatch.spec

    - name: Create Deb Package Structure
      env:
        APP_VERSION: ${{ env.APP_VERSION }}
      run: |
        mkdir -p deb_dist/streamcatch/usr/local/bin
        mkdir -p deb_dist/streamcatch/usr/share/applications
        mkdir -p deb_dist/streamcatch/usr/share/icons/hicolor/scalable/apps
        cp dist/StreamCatch deb_dist/streamcatch/usr/local/bin/streamcatch

        # Create Desktop Entry
        cat > deb_dist/streamcatch/usr/share/applications/streamcatch.desktop <<EOD
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=StreamCatch
        Comment=Ultimate Video Downloader
        Exec=/usr/local/bin/streamcatch
        Icon=streamcatch
        Terminal=false
        Categories=Network;FileTransfer;
        EOD

        # Copy Icon (Assuming SVG exists)
        if [ -f assets/logo.svg ]; then
          cp assets/logo.svg deb_dist/streamcatch/usr/share/icons/hicolor/scalable/apps/streamcatch.svg
        fi

        # Control File
        mkdir -p deb_dist/streamcatch/DEBIAN
        cat > deb_dist/streamcatch/DEBIAN/control <<EOD
        Package: streamcatch
        Version: ${APP_VERSION}
        Architecture: amd64
        Maintainer: StreamCatch Team
        Description: Ultimate Video Downloader
         StreamCatch is a powerful GUI video downloader supporting YouTube, Telegram, and more.
        EOD

    - name: Build Deb
      run: |
        dpkg-deb --build deb_dist/streamcatch
        mv deb_dist/streamcatch.deb streamcatch_${{ env.APP_VERSION }}_amd64.deb

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: StreamCatch_Linux_Deb
        path: streamcatch_*_amd64.deb
