name: Build Mobile Apps

on:
  workflow_call:
    inputs:
      build_android:
        description: 'Build for Android'
        required: false
        default: true
        type: boolean
      build_ios:
        description: 'Build for iOS'
        required: false
        default: false
        type: boolean
      tag_name:
        description: 'Tag name for release (e.g. v1.0.0)'
        required: false
        default: ''
        type: string
  workflow_dispatch:
    inputs:
      build_android:
        description: 'Build for Android'
        required: false
        default: true
        type: boolean
      build_ios:
        description: 'Build for iOS'
        required: false
        default: false
        type: boolean
      tag_name:
        description: 'Tag name for release (e.g. v1.0.0)'
        required: false
        default: ''
        type: string

env:
  PYTHON_VERSION: "3.12"
  FLUTTER_VERSION: "3.29.0"

jobs:
  version:
    uses: ./.github/workflows/get-version.yml
    with:
      tag_name: ${{ inputs.tag_name }}

  # ===========================================================================
  # Android Build
  # ===========================================================================
  build-android:
    name: Build Android
    needs: version
    if: inputs.build_android
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Set up Python
      uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c  # v5.0.0
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build APK
      env:
        APP_VERSION: ${{ needs.version.outputs.version }}
      run: |
        # Ensure pure python requirements are used (no binary wheels that won't work on Android)
        # But for 'flet build apk', it packages the python code.
        # We need to ensure we don't include heavy desktop libs if possible.
        
        flet build apk --verbose \
          --build-version "${{ env.APP_VERSION }}" \
          --project-name "StreamCatch" \
          --org "com.jules.streamcatch" \
          --product "StreamCatch" \
          --description "Ultimate Video Downloader" \
          --include-packages yt_dlp,requests,urllib3,certifi,idna,charset_normalizer,defusedxml,dateutil,bs4,PIL,pyperclip \
          main.py

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: StreamCatch-Android-APK
        path: |
          build/apk/*.apk
          build/**/*.apk
        if-no-files-found: warn

  # ===========================================================================
  # iOS Build (Requires Mac)
  # ===========================================================================
  build-ios:
    name: Build iOS
    needs: version
    if: inputs.build_ios
    runs-on: macos-14 # Required for Xcode 15+
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Set up Python
      uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c  # v5.0.0
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build iOS IPA (No signing for now - strictly build check)
      env:
        APP_VERSION: ${{ needs.version.outputs.version }}
      run: |
        flet build ipa --no-codesign --verbose \
          --build-version "${{ env.APP_VERSION }}" \
          --project-name "StreamCatch" \
          --org "com.jules.streamcatch" \
          --product "StreamCatch" \
          --include-packages yt_dlp,requests,urllib3,certifi,idna,charset_normalizer,defusedxml,dateutil,bs4,PIL,pyperclip \
          main.py

    - name: Upload iOS Archive
      uses: actions/upload-artifact@v4
      with:
        name: StreamCatch-iOS-Unsigned
        path: build/ios/Runner.xcarchive
        if-no-files-found: warn
