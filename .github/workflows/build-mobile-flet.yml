name: Build Mobile Apps

on:
  workflow_call:
    inputs:
      build_android:
        description: 'Build for Android'
        required: false
        default: true
        type: boolean
      build_ios:
        description: 'Build for iOS'
        required: false
        default: false
        type: boolean
      tag_name:
        description: 'Tag name for release (e.g. v1.0.0)'
        required: false
        default: ''
        type: string
  workflow_dispatch:
    inputs:
      build_android:
        description: 'Build for Android'
        required: false
        default: true
        type: boolean
      build_ios:
        description: 'Build for iOS'
        required: false
        default: false
        type: boolean
      tag_name:
        description: 'Tag name for release (e.g. v1.0.0)'
        required: false
        default: ''
        type: string

env:
  PYTHON_VERSION: "3.12"
  FLUTTER_VERSION: "3.19.0"

jobs:
  version:
    uses: ./.github/workflows/get-version.yml
    with:
      tag_name: ${{ inputs.tag_name }}

  # ===========================================================================
  # Android Build
  # ===========================================================================
  build-android:
    name: Build Android
    needs: version
    if: inputs.build_android
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

    - name: Setup Java
      uses: actions/setup-java@387ac29b308b003ca37ba93a6cab5eb57c8f5f93  # v4.0.0
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Flutter
      uses: subosito/flutter-action@62f096cacda5168a3bd7b95793373be14fa4fbaf  # v2.13.0
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Set up Python
      uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c  # v5.0.0
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-mobile.txt

    - name: Build APK
      env:
        APP_VERSION: ${{ needs.version.outputs.version }}
      run: |
        python scripts/build_mobile.py --target apk

    - name: Upload APK
      uses: actions/upload-artifact@c7d193f32edcb7bfad88892161225aeda64e9392  # v4.0.0
      with:
        name: StreamCatch-Android-APK
        path: |
          build/apk/*.apk
          build/**/*.apk
        if-no-files-found: warn

  # ===========================================================================
  # iOS Build (Requires Mac)
  # ===========================================================================
  build-ios:
    name: Build iOS
    needs: version
    if: inputs.build_ios
    runs-on: macos-14 # Required for Xcode 15+
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1

    - name: Setup Flutter
      uses: subosito/flutter-action@62f096cacda5168a3bd7b95793373be14fa4fbaf  # v2.13.0
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Set up Python
      uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c  # v5.0.0
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-mobile.txt

    - name: Build iOS IPA (No signing for now - strictly build check)
      env:
        APP_VERSION: ${{ needs.version.outputs.version }}
      run: |
        python scripts/build_mobile.py --target ipa

    - name: Upload iOS Archive
      uses: actions/upload-artifact@c7d193f32edcb7bfad88892161225aeda64e9392  # v4.0.0
      with:
        name: StreamCatch-iOS-Unsigned
        path: build/ios/Runner.xcarchive
        if-no-files-found: warn
